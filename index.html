<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Tracker</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
          apiKey: "AIzaSyCPKzqjPBawxv2DqMuYdwt5xf8sfyHeUJA",
          authDomain: "weekly-tracker-ef80d.firebaseapp.com",
          projectId: "weekly-tracker-ef80d",
          storageBucket: "weekly-tracker-ef80d.firebasestorage.app",
          messagingSenderId: "966514744052",
          appId: "1:966514744052:web:582787f45b48424ea4dca1",
          measurementId: "G-MFMCVG5N2C"
        };

        const appId = window.__app_id || 'default-app';
        let db, auth, user;
        let unsubscribeSnapshot = null;

        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Enable offline persistence if possible
                // enableIndexedDbPersistence(db).catch(err => console.log("Persistence error", err));

                // Monitor Auth State
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    window.user = u;
                    
                    if (u) {
                        // --- LOGGED IN ---
                        handleLoginSuccess(u);
                    } else {
                        // --- LOGGED OUT ---
                        handleLogout();
                    }
                });
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("Error initializing app. Check console.");
        }

        function handleLoginSuccess(u) {
            console.log("Google User Connected:", u.email);
            
            // 1. Hide Login Overlay
            const overlay = document.getElementById('loginOverlay');
            if(overlay) overlay.style.display = 'none';

            // 2. Auto-Fetch Name (First Name Only)
            if (u.displayName) {
                const firstName = u.displayName.split(' ')[0].toUpperCase();
                // Update local state if different
                if (window.appState.userName !== firstName) {
                    window.appState.userName = firstName;
                    window.saveState(); // Save name change immediately
                }
            }
            
            updateStatus('#4caf50', "Synced with Google", null);
            toggleAuthBtn(true);
            
            // 3. Force Sync: Push local data to cloud (handling the "Offline -> Online" case)
            if (typeof window.saveState === 'function') window.saveState();

            // 4. Start Listening to Cloud
            if (typeof window.syncData === 'function') window.syncData();
        }

        function handleLogout() {
            console.log("Logged Out");
            // Show Login Overlay
            const overlay = document.getElementById('loginOverlay');
            if(overlay) overlay.style.display = 'flex';
            
            updateStatus('#9e9e9e', "Waiting for Login...", null);
            toggleAuthBtn(false);
            
            if(unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }
        }

        // Auth Functions
        window.loginWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Failed:", error);
                alert("Login Failed: " + error.message);
            }
        };

        window.logout = async function() {
            try {
                if(confirm("Log out?")) {
                    await signOut(auth);
                    window.location.reload(); 
                }
            } catch (error) {
                console.error("Logout Failed:", error);
            }
        };

        function toggleAuthBtn(isLoggedIn) {
            const btn = document.getElementById('authBtn');
            if(btn) {
                if(isLoggedIn) {
                    btn.innerText = "Sign Out";
                    btn.onclick = window.logout;
                    btn.style.background = "#555";
                }
            }
        }

        function updateStatus(color, message, clickAction) {
            const statusDot = document.getElementById('connectionStatus');
            if(statusDot) {
                statusDot.style.backgroundColor = color;
                statusDot.title = message;
                statusDot.onclick = clickAction || null;
                statusDot.style.cursor = clickAction ? "pointer" : "help";
            }
        }

        // Handle network recovery explicitly
        window.addEventListener('online', () => {
            console.log("Network Online - Syncing...");
            if(window.user) window.saveState();
        });

        window.db = db;
        window.auth = auth;
        window.user = user;
        window.appId = appId;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.updateStatus = updateStatus;
        window.setUnsubscribe = (fn) => { unsubscribeSnapshot = fn; };
    </script>

    <style>
        :root {
            --bg-color: #fcfcfc;
            --text-color: #222;
            --border-color: #222;
            --highlight: #222;
            --font-main: "Courier New", Courier, monospace;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: #fff;
            border: 2px solid var(--border-color);
            padding: 2rem;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* --- LOGIN OVERLAY --- */
        #loginOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex; /* Flex by default, hidden by JS */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .login-card {
            text-align: center;
            padding: 3rem;
            border: 2px solid #222;
            background: #fff;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
        }

        .login-btn {
            background: #4285F4;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            margin-right: auto;
            transition: transform 0.1s;
        }
        .login-btn:active { transform: scale(0.98); }

        /* --- HEADER & TITLES --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            gap: 1rem;
        }

        .title-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #connectionStatus {
            width: 10px;
            height: 10px;
            background-color: #9e9e9e;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.2rem;
            font-family: var(--font-sans);
        }

        .week-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.2rem;
        }

        .editable {
            background: transparent;
            border: none;
            border-bottom: 1px dashed #999;
            font-family: inherit;
            color: inherit;
            outline: none;
            text-align: right;
            font-size: 1rem;
            width: 140px;
        }

        /* --- BUTTONS --- */
        button { cursor: pointer; font-family: inherit; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }

        .btn-print, .btn-reset, .btn-help, .btn-auth {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            transition: opacity 0.2s, background 0.2s;
        }
        
        .btn-reset {
            background: white;
            color: var(--text-color);
            border: 1px solid var(--text-color);
        }

        .btn-help {
            background: #eee;
            color: #222;
        }
        
        .btn-auth { min-width: 80px; }

        .btn-print:hover, .btn-reset:hover, .btn-help:hover, .btn-auth:hover { opacity: 0.8; }

        /* --- SECTIONS --- */
        h2 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
        }
        h2::after {
            content: ''; flex: 1; height: 1px;
            background: var(--border-color); opacity: 0.3;
        }

        /* --- EFFORT SCORE --- */
        .effort-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .effort-boxes { display: flex; gap: 0.5rem; }
        .effort-box {
            width: 24px; height: 24px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        .effort-box.filled {
            background-color: var(--highlight) !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* --- HABITS TABLE --- */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .quests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 500px;
        }
        .quests-table th {
            text-align: center; padding: 0.5rem;
            font-weight: normal;
            border-bottom: 1px solid var(--border-color);
            width: 40px;
        }
        .quests-table th:first-child { text-align: left; width: auto; }
        .quests-table td {
            border-bottom: 1px solid #eee; padding: 0.5rem 0;
        }
        .habit-check {
            width: 20px; height: 20px;
            border: 1px solid #ccc;
            margin: 0 auto;
            cursor: pointer;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .habit-check.checked::after {
            content: ''; width: 12px; height: 12px;
            background-color: var(--highlight) !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            border-radius: 50%;
        }
        .habit-name {
            width: 100%; border: none; font-family: inherit;
            font-size: 1rem; outline: none; background: transparent;
        }

        /* --- DATA VIS --- */
        .data-vis-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 2rem;
            align-items: start;
        }
        .chart-wrapper {
            position: relative; height: 200px; width: 100%;
            border-left: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        canvas { display: block; width: 100%; height: 100%; }
        .data-inputs {
            display: flex; flex-direction: column;
            gap: 0.5rem; font-size: 0.8rem;
            font-family: var(--font-sans);
        }
        .data-row {
            display: flex; justify-content: space-between; align-items: center;
        }
        .data-input-field {
            width: 40px; border: 1px solid #ccc;
            padding: 2px; text-align: right; font-family: var(--font-main);
        }

        /* --- REFLECTION --- */
        .reflection-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;
        }
        .reflection-box label {
            display: block; font-size: 0.8rem; font-weight: bold;
            margin-bottom: 0.5rem; font-family: var(--font-sans);
            text-transform: uppercase;
        }
        textarea {
            width: 100%; border: 1px solid #ddd;
            background: #fafafa; padding: 0.5rem;
            font-family: var(--font-main); font-size: 0.9rem;
            resize: none; min-height: 100px; outline: none; line-height: 1.4;
        }
        textarea:focus { border-color: #000; background: #fff; }

        /* --- CHAOS BOX --- */
        .chaos-header {
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-clear {
            background: none; border: 1px solid #ccc;
            padding: 2px 8px; font-size: 0.7rem; text-transform: uppercase;
        }

        /* --- TUTORIAL STYLES --- */
        .tutorial-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9000;
            display: none;
        }
        .tutorial-card {
            background: #fff; border: 2px solid #222; padding: 1.5rem;
            max-width: 350px; width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 9002;
            animation: slideIn 0.3s ease;
            position: fixed; bottom: 30px; right: 30px;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .t-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; text-transform: uppercase; }
        .t-text { font-family: var(--font-sans); font-size: 0.9rem; line-height: 1.5; color: #444; margin-bottom: 1rem; }
        .t-progress { font-size: 0.7rem; color: #999; margin-bottom: 1rem; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .t-btn-row { display: flex; justify-content: flex-end; gap: 1rem; }
        
        .tutorial-active {
            position: relative; z-index: 9001 !important;
            background-color: white; box-shadow: 0 0 0 4px #222;
            transition: all 0.3s ease; pointer-events: none;
        }

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .container { padding: 1rem; gap: 1.5rem; }
            header { flex-direction: column; align-items: flex-start; }
            .week-input-wrapper { width: 100%; align-items: flex-start; margin-top: 0.5rem; }
            .editable { text-align: left; width: 100%; }
            .btn-group { width: 100%; justify-content: flex-start; margin-top: 1rem; flex-wrap: wrap;}
            .data-vis-container { grid-template-columns: 1fr; }
            .data-inputs { grid-template-columns: 1fr 1fr; gap: 1rem; display: grid; }
            .reflection-grid { grid-template-columns: 1fr; }
            
            /* Bottom Sheet Tutorial on Mobile */
            .tutorial-card { bottom: 20px; right: 20px; left: 20px; width: auto; max-width: none; }
        }

        @media print {
            body { background: white; padding: 0; }
            .container { border: none; box-shadow: none; padding: 0; }
            .btn-group, .btn-clear, .data-inputs, .tutorial-overlay, #loginOverlay { display: none; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<!-- LOGIN OVERLAY (BLOCKS CONTENT) -->
<div id="loginOverlay">
    <div class="login-card">
        <h1>THE PROTOCOL</h1>
        <p style="font-family: var(--font-sans); color: #666; margin-top: 0.5rem;">Access Restricted</p>
        <button class="login-btn" onclick="loginWithGoogle()">
            <span>üîí Login with Google</span>
        </button>
        <p style="font-size: 0.75rem; color: #999; margin-top: 2rem;">Offline? Data saves locally and syncs on connection.</p>
    </div>
</div>

<div class="container">
    <!-- HEADER -->
    <header id="headerSection">
        <div>
            <div class="title-group">
                <div id="connectionStatus" title="Status"></div>
                <h1 id="protocolTitle">THE PROTOCOL</h1>
            </div>
            <div class="subtitle">v3.6 // Automated Edition</div>
        </div>
        <div style="width: 100%;">
            <div class="btn-group">
                <button id="authBtn" class="btn-auth" onclick="loginWithGoogle()">Sign Out</button>
                <button class="btn-help" onclick="startTutorial()">Tutorial</button>
                <button class="btn-reset" onclick="resetWeek()">Reset</button>
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è PDF</button>
            </div>
            <div class="week-input-wrapper">
                <label style="font-size: 0.7rem; font-weight: bold; font-family: var(--font-sans);">WEEK OF:</label>
                <input type="text" id="weekOf" class="editable" placeholder="DD/MM/YYYY">
            </div>
        </div>
    </header>

    <!-- EFFORT SCORE -->
    <section id="effortSection">
        <h2>Effort Score</h2>
        <div class="effort-container">
            <div class="effort-boxes" id="effortContainer"></div>
            <div style="font-size: 0.85rem; font-family: var(--font-sans); color: #555;">
                <span id="effortCount" style="font-weight: bold;">0/7</span>
                <span style="margin: 0 0.5rem; color: #ccc;">|</span>
                <span>Consistency > Perfection</span>
            </div>
        </div>
    </section>

    <!-- QUESTS / HABITS -->
    <section id="habitsSection">
        <h2>Quests & Habits</h2>
        <div class="table-wrapper">
            <table class="quests-table">
                <thead>
                    <tr>
                        <th>QUEST NAME</th>
                        <th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th>
                    </tr>
                </thead>
                <tbody id="habitsBody"></tbody>
            </table>
        </div>
    </section>

    <!-- DATA VISUALIZATION -->
    <section id="metricsSection">
        <h2>Bio-Metrics</h2>
        <div class="data-vis-container">
            <div>
                <div class="chart-wrapper">
                    <canvas id="metricsChart"></canvas>
                </div>
            </div>
            <div class="data-inputs" id="dataInputs">
                <!-- Inputs generated by JS -->
            </div>
        </div>
    </section>

    <!-- REFLECTION -->
    <section id="reflectionSection">
        <h2>Weekly De-Brief</h2>
        <div class="reflection-grid">
            <div class="reflection-box">
                <label>What Worked?</label>
                <textarea id="ref_worked" oninput="autoResize(this)"></textarea>
            </div>
            <div class="reflection-box">
                <label>What Didn't?</label>
                <textarea id="ref_didnt" oninput="autoResize(this)"></textarea>
            </div>
            <div class="reflection-box">
                <label>Next Wk Adjustment</label>
                <textarea id="ref_adjust" oninput="autoResize(this)"></textarea>
            </div>
        </div>
    </section>

    <!-- CHAOS BOX -->
    <section class="chaos-box" id="chaosSection">
        <div class="chaos-header">
            <h2>Chaos Box</h2>
            <button class="btn-clear" onclick="clearChaos()">Clear</button>
        </div>
        <textarea id="chaosBox" placeholder="Unload your mind here..." oninput="autoResize(this)"></textarea>
    </section>
</div>

<!-- TUTORIAL OVERLAY -->
<div id="tutorialOverlay" class="tutorial-overlay">
    <div class="tutorial-card">
        <div class="t-title" id="tTitle">Welcome</div>
        <div class="t-text" id="tText">Content goes here</div>
        <span class="t-progress" id="tProgress">1 / 5</span>
        <div class="t-btn-row">
            <button class="btn-help" style="background:transparent; border:1px solid #ccc; font-size:0.7rem;" onclick="endTutorial()">Exit</button>
            <button class="btn-print" id="tNextBtn" style="font-size:0.7rem;" onclick="nextTutorialStep()">Next ></button>
        </div>
    </div>
</div>

<script type="module">
    // Re-importing inside module for logic execution if needed, but main logic is below
</script>

<script>
    // --- STATE MANAGEMENT ---
    const DEFAULT_STATE = {
        userName: null,
        weekOf: "",
        tutorialSeen: false,
        effort: Array(7).fill(false),
        habits: [
            { name: "Deep Work (2h)", days: Array(7).fill(false) },
            { name: "Movement", days: Array(7).fill(false) },
            { name: "Reading", days: Array(7).fill(false) },
            { name: "Hydration", days: Array(7).fill(false) },
            { name: "No Phone AM", days: Array(7).fill(false) },
            { name: "Skill Practice", days: Array(7).fill(false) },
            { name: "Journaling", days: Array(7).fill(false) }
        ],
        metrics: {
            screen: Array(7).fill(0),
            sleep: Array(7).fill(0)
        },
        reflection: { worked: "", didnt: "", adjust: "" },
        chaos: ""
    };

    window.appState = JSON.parse(localStorage.getItem('prithvi_v4')) || DEFAULT_STATE;

    // --- MIGRATION & INIT ---
    if (window.appState.habits.length < 7) {
        const missing = 7 - window.appState.habits.length;
        for(let i=0; i<missing; i++) {
            window.appState.habits.push({ name: "", days: Array(7).fill(false) });
        }
    }

    // --- TUTORIAL LOGIC ---
    const tutorialSteps = [
        {
            target: 'headerSection',
            title: "1. Weekly Setup",
            text: "Welcome. Your name was fetched from Google. Enter the 'Week Of' date here to label your records."
        },
        {
            target: 'effortSection',
            title: "2. The Effort Score",
            text: "This is your daily 'Show Up' metric. Aim for 4/7 consistent days to build momentum."
        },
        {
            target: 'habitsSection',
            title: "3. Quests & Habits",
            text: "Click habit names to customize. Click circles to complete. Simple."
        },
        {
            target: 'metricsSection',
            title: "4. Bio-Metrics",
            text: "Input Screen Time (Srn) and Sleep (Slp). The graph updates live."
        },
        {
            target: 'reflectionSection',
            title: "5. Weekly De-Brief",
            text: "Be honest. What worked? What broke? Adjust your strategy here."
        },
        {
            target: 'chaosSection',
            title: "6. The Chaos Box",
            text: "Dump tasks, anxieties, or random thoughts here to keep your mind clear."
        }
    ];

    let currentStep = 0;

    window.startTutorial = function() {
        currentStep = 0;
        document.getElementById('tutorialOverlay').style.display = 'block';
        showStep(0);
    }

    window.nextTutorialStep = function() {
        if (tutorialSteps[currentStep].target) {
            document.getElementById(tutorialSteps[currentStep].target).classList.remove('tutorial-active');
        }
        currentStep++;
        if (currentStep >= tutorialSteps.length) {
            endTutorial();
        } else {
            showStep(currentStep);
        }
    }

    function showStep(index) {
        const step = tutorialSteps[index];
        document.getElementById('tTitle').innerText = step.title;
        document.getElementById('tText').innerText = step.text;
        document.getElementById('tProgress').innerText = `${index + 1} / ${tutorialSteps.length}`;
        
        if (step.target) {
            const el = document.getElementById(step.target);
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.add('tutorial-active');
        }

        const btn = document.getElementById('tNextBtn');
        if (index === tutorialSteps.length - 1) {
            btn.innerText = "Finish";
            btn.style.backgroundColor = "#4caf50";
            btn.style.color = "white";
        } else {
            btn.innerText = "Next >";
            btn.style.backgroundColor = "";
            btn.style.color = "";
        }
    }

    window.endTutorial = function() {
        if (currentStep < tutorialSteps.length && tutorialSteps[currentStep].target) {
            document.getElementById(tutorialSteps[currentStep].target).classList.remove('tutorial-active');
        }
        document.getElementById('tutorialOverlay').style.display = 'none';
        window.appState.tutorialSeen = true;
        saveState();
    }

    // --- MAIN INIT ---
    function init() {
        updateTitle();
        renderWeekInput();
        renderEffort();
        renderHabits();
        renderMetricsInputs();
        renderReflection();
        renderChaos();
        drawChart();

        window.addEventListener('resize', drawChart);
        window.addEventListener('beforeprint', drawChart);
        
        // Trigger Tutorial only if logged in AND not seen
        if (window.user && !window.appState.tutorialSeen) {
            setTimeout(() => { startTutorial(); }, 1000);
        }
    }

    // --- CORE FUNCTIONS ---

    window.saveState = function() {
        localStorage.setItem('prithvi_v4', JSON.stringify(window.appState));
        updateTitle();
        
        if (window.user && window.db && window.setDoc && window.doc) {
            try {
                const userDoc = window.doc(window.db, 'artifacts', window.appId, 'users', window.user.uid, 'data', 'tracker');
                const userMetaDoc = window.doc(window.db, 'artifacts', window.appId, 'users', window.user.uid);
                
                window.setDoc(userMetaDoc, { name: window.appState.userName, lastUpdated: new Date() }, { merge: true });
                window.setDoc(userDoc, window.appState, { merge: true })
                    .catch((err) => console.error("Save Error:", err));
            } catch (e) {
                console.error("Firestore Error:", e);
            }
        }
    }

    window.updateTitle = function() {
        const titleEl = document.getElementById('protocolTitle');
        const name = window.appState.userName ? window.appState.userName : "USER";
        titleEl.innerText = `THE ${name} PROTOCOL`;
        
        const week = window.appState.weekOf ? window.appState.weekOf : "Weekly";
        document.title = `${week} - ${name} Protocol`;
    }

    // Removed manual rename logic to rely on Google Auth Name
    window.renameProtocol = function() {
        // Optional: Can re-enable if user wants manual override
        // But requested to "fetch first name from google" only.
    }
    
    // --- SYNC LOGIC ---
    window.syncData = function() {
        if (!window.user || !window.db || !window.doc || !window.onSnapshot) return;
        
        const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', window.user.uid, 'data', 'tracker');
        
        const unsub = window.onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
                const cloudData = snap.data();
                if (JSON.stringify(cloudData) !== JSON.stringify(window.appState)) {
                    console.log("Syncing from cloud...");
                    window.appState = cloudData;
                    // Ensure habits consistency
                    if (window.appState.habits.length < 7) {
                        const missing = 7 - window.appState.habits.length;
                        for(let i=0; i<missing; i++) {
                            window.appState.habits.push({ name: "", days: Array(7).fill(false) });
                        }
                    }
                    localStorage.setItem('prithvi_v4', JSON.stringify(window.appState));
                    refreshUI();
                }
            }
        });
        
        if(window.setUnsubscribe) window.setUnsubscribe(unsub);
    };
    
    function refreshUI() {
        window.updateTitle();
        renderWeekInput();
        renderEffort();
        renderHabits();
        renderMetricsInputs();
        renderReflection();
        renderChaos();
        drawChart();
    }

    window.resetWeek = function() {
        if (!confirm("Start a new week? Keeps habit names, clears data.")) return;
        window.appState.effort = Array(7).fill(false);
        window.appState.habits.forEach(h => h.days = Array(7).fill(false));
        window.appState.metrics.screen = Array(7).fill(0);
        window.appState.metrics.sleep = Array(7).fill(0);
        window.appState.reflection = { worked: "", didnt: "", adjust: "" };
        window.appState.chaos = "";
        saveState();
        refreshUI();
        document.querySelectorAll('textarea').forEach(t => t.value = "");
    }

    // --- RENDERERS ---
    function renderWeekInput() {
        const el = document.getElementById('weekOf');
        el.value = window.appState.weekOf;
        el.oninput = (e) => {
            window.appState.weekOf = e.target.value;
            saveState();
        };
    }

    function renderEffort() {
        const container = document.getElementById('effortContainer');
        container.innerHTML = '';
        window.appState.effort.forEach((filled, i) => {
            const box = document.createElement('div');
            box.className = `effort-box ${filled ? 'filled' : ''}`;
            box.onclick = () => {
                window.appState.effort[i] = !window.appState.effort[i];
                saveState();
                renderEffort();
            };
            container.appendChild(box);
        });
        document.getElementById('effortCount').innerText = `${window.appState.effort.filter(Boolean).length}/7`;
    }

    function renderHabits() {
        const tbody = document.getElementById('habitsBody');
        tbody.innerHTML = '';
        window.appState.habits.forEach((habit, hIndex) => {
            const tr = document.createElement('tr');
            const tdName = document.createElement('td');
            const input = document.createElement('input');
            input.className = 'habit-name';
            input.value = habit.name;
            input.placeholder = "New Habit...";
            input.oninput = (e) => {
                window.appState.habits[hIndex].name = e.target.value;
                localStorage.setItem('prithvi_v4', JSON.stringify(window.appState));
            };
            input.onblur = () => saveState();
            tdName.appendChild(input);
            tr.appendChild(tdName);

            habit.days.forEach((checked, dIndex) => {
                const td = document.createElement('td');
                const div = document.createElement('div');
                div.className = `habit-check ${checked ? 'checked' : ''}`;
                div.onclick = () => {
                    window.appState.habits[hIndex].days[dIndex] = !window.appState.habits[hIndex].days[dIndex];
                    div.className = `habit-check ${window.appState.habits[hIndex].days[dIndex] ? 'checked' : ''}`;
                    saveState();
                };
                td.appendChild(div);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function renderMetricsInputs() {
        const container = document.getElementById('dataInputs');
        if (container.children.length > 0) {
            const inputs = container.querySelectorAll('input');
            let idx = 0;
            for(let i=0; i<7; i++) {
                if(inputs[idx]) inputs[idx].value = window.appState.metrics.screen[i];
                idx++;
                if(inputs[idx]) inputs[idx].value = window.appState.metrics.sleep[i];
                idx++;
            }
            return;
        }
        container.innerHTML = '<strong style="margin-bottom:0.5rem; display:block;">Hrs: Screen | Sleep</strong>';
        const days = ['M','T','W','T','F','S','S'];
        days.forEach((day, i) => {
            const row = document.createElement('div');
            row.className = 'data-row';
            const divInputs = document.createElement('div');
            divInputs.style.display = 'flex';
            divInputs.style.gap = '5px';
            const screenIn = createNumInput(window.appState.metrics.screen[i], (v) => {
                window.appState.metrics.screen[i] = v; saveState(); drawChart();
            });
            const sleepIn = createNumInput(window.appState.metrics.sleep[i], (v) => {
                window.appState.metrics.sleep[i] = v; saveState(); drawChart();
            });
            divInputs.appendChild(screenIn);
            divInputs.appendChild(sleepIn);
            row.innerHTML = `<span>${day}</span>`;
            row.appendChild(divInputs);
            container.appendChild(row);
        });
    }

    function createNumInput(val, callback) {
        const input = document.createElement('input');
        input.type = 'number';
        input.step = '0.5';
        input.className = 'data-input-field';
        input.value = val || '';
        input.onchange = (e) => callback(parseFloat(e.target.value) || 0);
        return input;
    }

    function renderReflection() {
        setRefVal('ref_worked', 'worked');
        setRefVal('ref_didnt', 'didnt');
        setRefVal('ref_adjust', 'adjust');
    }

    function setRefVal(id, key) {
        const el = document.getElementById(id);
        el.value = window.appState.reflection[key];
        el.oninput = (e) => {
            window.appState.reflection[key] = e.target.value;
            localStorage.setItem('prithvi_v4', JSON.stringify(window.appState));
            autoResize(el);
        };
        el.onblur = () => saveState();
        autoResize(el);
    }

    function renderChaos() {
        const el = document.getElementById('chaosBox');
        el.value = window.appState.chaos;
        el.oninput = (e) => {
            window.appState.chaos = e.target.value;
            localStorage.setItem('prithvi_v4', JSON.stringify(window.appState));
            autoResize(el);
        };
        el.onblur = () => saveState();
        autoResize(el);
    }

    window.clearChaos = function() {
        if(confirm("Clear chaos box?")) {
            window.appState.chaos = "";
            document.getElementById('chaosBox').value = "";
            saveState();
        }
    }

    window.autoResize = function(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    // --- CHART ---
    function drawChart() {
        const canvas = document.getElementById('metricsChart');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const w = rect.width;
        const h = rect.height;
        const pad = 20;
        const chW = w - (pad * 2);
        const chH = h - (pad * 2);
        ctx.clearRect(0, 0, w, h);
        const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
        const stepX = chW / 7;
        const maxVal = 12;
        ctx.strokeStyle = '#eee';
        ctx.fillStyle = '#999';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        days.forEach((d, i) => ctx.fillText(d, pad + (i*stepX) + (stepX/2), h - 5));
        [0, 0.5, 1].forEach(r => {
            let y = pad + (chH * r);
            ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.stroke();
        });
        ctx.fillStyle = '#ddd';
        window.appState.metrics.screen.forEach((v, i) => {
            let val = Math.min(v, maxVal);
            let bh = (val/maxVal) * chH;
            let bw = stepX * 0.4;
            let x = pad + (i*stepX) + (stepX/2) - (bw/2);
            let y = (h - pad) - bh;
            ctx.fillRect(x, y, bw, bh);
        });
        ctx.beginPath();
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 2;
        window.appState.metrics.sleep.forEach((v, i) => {
            let val = Math.min(v, maxVal);
            let y = (h - pad) - ((val/maxVal) * chH);
            let x = pad + (i*stepX) + (stepX/2);
            if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

    init();
</script>
</body>
</html>
